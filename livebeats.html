<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<title>Live Beats | g200kg Music &amp; Software</title>
<style>
body{
	margin:0;
	padding:0;
}
#urlpane{
	display:none;
	position:absolute;
	width:100%;
	height:300px;
	left:0px;
	top:0px;
	background:#888;
	margin:0;
	padding:0;
	border:none;
}
#url{
	margin-top:20px;
	width:100%;
	height:100px;
}
#mess{
	position:absolute;
	left:0;
	top:0;
	width:100%;
	padding:20px;
	background:#ccc;
}
</style>
</head>
<body onload="Init()" style="background:#000">

<script type="text/javascript" src="./vj_txt.js"></script>
<script type="text/javascript" src="./vj_wavegl.js"></script>
<script type="text/javascript" src="./vj_matrix.js"></script>
<!--<script type="text/javascript" src="./vj_camgl.js"></script>-->
<script type="text/javascript" src="./vj_camformantgl.js"></script>
<script type="text/javascript" src="./vj_dropgl.js"></script>
<!--<script type="text/javascript" src="./vj_beatstep.js"></script>-->
<script type="text/javascript">

//var internalResoX=800;
//var internalResoY=600;
var internalResoX=window.innerWidth;
var internalResoY=window.innerHeight;

var nocam=0;
var cmdlinemode=0;
var buffers = [];
var loadidx=0;
var req = new XMLHttpRequest();
var wavdat=new Uint8Array(512);
var freqdat=new Uint8Array(256);
var cnt=0;
var lfo1=0;
var lfo2=0;
var lfo4=0;
var lfo8=0;
var lfo16=0;
var lfo32=0;
var lfo48=0;
var lfo64=0;
var sh1=0;
var sh2=0;
var sh4=0;
var sh8=0;
var sh16=0;
var beat4=0;
var beat8=0;
var beat16=0;
var beat32=0;
var beat64=0;
var cc=[0,0,0,0,0,0,0,0];
var rand1=rand2=rand4=0;
var lev=0;
var bd1="crrrcrrrcrrrcrcr";
var sd1="rrrrcrrrrrrrcrrr";
var hh1="crcrcrcrcrcrcrcc";
var s0="rrrrrrrrrrrrrrrr";
var s1="crrrcrrrcrrrcrrr";
var s2="aarrddrrcrcrerrr";
var s3="gagarrrrddrreerr";
var s4="grrrddeegrrrddcc";
var s5="errrcrerarddcrrr";
var s6="crrrargrdcgrardr";
var s7="ererggeecdrcgrrr";
var s8="errrarrrgrrrerfr";
var s9="ddddrrrrggggdddd";
var s10="crrrcrrrcrrrcrrr";
var s11="aaaarrrrrrrrrrrr";
var s12="aaaarrrrddddrrrr";
var s13="ddggrraaaaggdrdr";
var s14="arrrggrrgrrreerr";
var s15="crargrcrarrrdrrr";
var s16="rrrrgrggrrrreree";
var s17="crrrdrerrrcrdrer";
var s18="eeeerrddeeeerrgg";
var s19="arrrrrrrrrrrrrrr";
var s20="cdegacdegeadcged";
var s21="dadcgagcacdegaed";
var s23="grcdgrcdarrrabab";
var s24="eergeergaardaard";
var tick=0;
var mouse={"px":0,"py":0,"pz":0};
var nextTime=0;

var master=null;
var midi=null;
var o1,o2,o3,o4,o5,o6,o7,o8;
var delay;
var video=null;
var eff=null;
var elEff=null;
var scrWidth=100;
var scrHeight=100;

var list=[];
var ir=[];
var shot=[];
var plugins=[];
var pluginsparam=[];
var midicb=[];

var fn=[
	"dmx.p0=0;dmx.p2=9;dmx.p3=0;dmx.p4=0;dmx.p6=0",
	"wav.type=0;wav.fill=0;wav.effr=.9;wav.effx=0;wav.effy=0;wav.effz=1.05",
	"wav.type=1;wav.fill=0;wav.effr=.9;wav.effx=0;wav.effy=10;wav.effz=1",
	"wav.type=2;wav.fill=0;wav.effr=.9;wav.effx=0;wav.effy=0;wav.effz=1.05",
	"wav.type=2;wav.fill=1;wav.effr=.9;wav.effx=0;wav.effy=0;wav.effz=1.05",
	"cam.a=0;cam.v=0;wav.a=0",
	"",
	"bdo.v=0;sdo.v=0;hho.v=0;cam.v=0",
	"bdo.v=.5;sdo.v=.5;hho.v=.5",
	"",
	"",
	"",
];

function Trigger(instrument,accent,when) {
	if(accent==0)
		return;
	var src=audioctx.createBufferSource();
	src.buffer=buffers[instrument];
	var g=audioctx.createGain();
	g.gain.value=0.8;
	src.connect(g);
	g.connect(out);
	src.start(when);
}
function DragOver(ev) {
	ev.stopPropagation();
	ev.preventDefault();
	ev.dataTransfer.dropEffect="copy";
}
function _LoadPlugin(script,name,layer) {
	var plug={"script":script,"name":name};
	eval("plug.obj=new "+script+"({'w':"+internalResoX+",'h':"+internalResoY+",'cmds':cmds,'wavedat':wavdat,'freqdat':freqdat,'video':video.video,'audioctx':audioctx,'dest':master.out,'senddest':delay.Dly})");
	InitPlugin(plug,layer);
	console.log("LoadPlugin:",script,name);
	return plug;
}
function NamePlugin(name) {
	var n=name.split("=");
	if(n.length!=2)
		return "usage: name oldName=newName\n";
	for(i=0;i<plugins.length;++i) {
		if(plugins[i].name==n[0]) {
			plugins[i].name=n[1];
			return "'"+n[0]+"' is named '"+n[1]+"'\n";
		}
	}
	return "plugin '"+n[0]+"' is not found.\n";
}
function LoadPlugin(name) {
	var n=name.split("=");
	if(n.length!=2)
		return "usage: load Name=ScriptName\n";
	_LoadPlugin(n[1],n[0],"base");
	return "plugin '"+n[1]+"' is loaded as '"+n[0]+"'\n";
}
function DeletePlugin(name) {
	var i;
	for(i=0;i<plugins.length;++i) {
		if(plugins[i].name==name)
			break;
	}
	if(i==plugins.length) {
		return "plugin '"+name+"' is not found.\n";
	}
	var plug=plugins[i];
	if(plug.obj.destroy)
		plug.obj.destroy();
	document.getElementById("base").removeChild(plug.obj.elem);
	plugins.splice(i,1);
	pluginsparam.splice(i,1);
	return "plugin '"+name+"' is deleted.\n";
}
function InitPlugin(plug,layer) {
	if(!plug.obj || !plug.obj.elem || !plug.obj.param)
		return;
	plug.obj.elem.style.position="absolute";
	plug.obj.elem.style.left="0px";
	plug.obj.elem.style.top="0px";
	plugins.push(plug);
	pluginsparam.push({});
	var p={
		"a":{"value":0,"defval":0,"define":1,"min":0,"max":0.999},
		"rot":{"value":0,"defval":0,"define":1,"min":-360,"max":360},
		"w":{"value":1,"defval":1,"define":1,"min":0,"max":1},
		"h":{"value":1,"defval":1,"define":1,"min":0,"max":1},
		"x":{"value":.5,"defval":.5,"define":1,"min":0,"max":1},
		"y":{"value":.5,"defval":.5,"define":1,"min":0,"max":1},
		"z":{"value":1,"defval":1,"define":1,"min":0,"max":2},
	};
	for(var j in plug.obj.param){
		p[j]=plug.obj.param[j];
		p[j].defval=p[j].value;
	}
	plug.obj.param=p;
	document.getElementById(layer).appendChild(plug.obj.elem);
	cmds.message("plugin '"+plug.script+"' is loaded as:"+plug.name);
	if(plug.obj.onmidimessage){
		midicb.push({func:plug.obj.onmidimessage,plug:plug.obj});
	}
}
function FileDrop(ev) {
	ev.stopPropagation();
	ev.preventDefault();
	var files=ev.dataTransfer.files;
	var name=files[0].name;
	if(name.indexOf("vj_")==0 && name.lastIndexOf(".js")==name.length-3) {
		name=name.substr(0,name.length-3);
		var reader=new FileReader();
		reader.onload=function(ev) {
			eval(ev.target.result);
			_LoadPlugin(this.name,"plug"+plugins.length,"base");
		};
		reader.name=name;
		reader.readAsText(files[0]);
	}
}
function animInterval(timestamp) {
	var layout=false;
	if(master.run==0)
		return;
	if(timestamp-lastTime>50) {
		lastTime=timestamp;
	}
	else {
		return;
	}
	if(++master.tccnt>=10){
		layout=true;
		document.getElementById("timecode").innerHTML=Timecode(audioctx.currentTime);
	}
	master.ana.getByteTimeDomainData(wavdat);
	master.ana.getByteFrequencyData(freqdat);
	for(var i=0,e=plugins.length;i<e;++i) {
		var plug=plugins[i].obj;
		var plugparam=pluginsparam[i];
		plug.anim(timestamp);
		for(var j in plugparam) {
			if(plug.param[j]) {
				if(isNaN(plug.param[j].value))
					plug.param[j].value=0;
				switch(plug.param[j].type) {
				case "string":
					plug.param[j].value=streval(plugparam[j]);
					break;
				case "int":
					plug.param[j].value=numeval(plugparam[j])|0;
					break;
				case "double":
				default:
					var v=numeval(plugparam[j]);
					var d=v-plug.param[j].value;
					if(Math.abs(d)<1e-10)
						plug.param[j].value=v;
					else
						plug.param[j].value+=d*.2;
					break;
				}
			}
		}
		if(layout) {
			var w,h;
			if(plug.param.z.define){
				w=plug.param.w.value*plug.param.z.value;
				h=plug.param.h.value*plug.param.z.value;
			}
			else{
				w=plug.param.w.value;
				h=plug.param.h.value;
			}
			plug.elem.style.left=((scrWidth*plug.param.x.value-scrWidth*w*.5)|0)+"px";
			plug.elem.style.top=((scrHeight*plug.param.y.value-scrHeight*h*.5)|0)+"px";
			plug.elem.style.width=((scrWidth*w)|0)+"px";
			plug.elem.style.height=((scrHeight*h)|0)+"px";
//			plug.elem.style.opacity=0.99;//Math.min(0.999,parseFloat(plug.param.a.value));
/*			plug.elem.style.WebkitFilter="blur("+(plug.param.blur.value|0)+"px)";
			plug.elem.style.WebkitFilter=plug.elem.style.mozFilter="hue-rotate("+plug.param.hue.value+"deg)";
*/
//			if(plug.param.rot.define)
//				plug.elem.style.transform="rotate("+plug.param.rot.value+"deg)";
		}
	}
//	window.requestAnimationFrame(animInterval);
}
function CmdInit(){
	var cmd=location.search.slice(1).split('&');
	for(var i=0;i<cmd.length;++i){
		var c=decodeURIComponent(cmd[i]);
		cmds.message(c);
		cmds.input(c);
	}
	setInterval(Interval,30);
}
function WaitReady(){
	console.log("loadcnt:"+master.loadcnt);
	if(master.loadcnt>0){
		setTimeout(WaitReady,200);
		return;
	}
	console.log("CmdInit");
	CmdInit();
}
function Init() {
	console.log("Init start");
	if(location.search.indexOf("nocam=1")>=0){
		nocam=1;
	}
	window.AudioContext=window.webkitAudioContext||window.AudioContext;
	audioctx=new AudioContext();
	midi=new Midi();
	master=new Master();

	out=master.out;
	run=1;
	dmx=new DMX();
	delay=new Delay();
	o1=new OSC(110,0.8,1,out);
	o2=new OSC(440,0.5,1,out);
	o3=new OSC(440,0.5,1,out);
	o4=new OSC(880,0.5,1,out);
	o5=new OSC(110,0.5,1,out);
	o6=new OSC(440,0.5,1,out);
	o7=new OSC(440,0.5,1,out);
	o8=new OSC(880,0.5,1,out);
	bdo=new FMO(115,.5,.8,.2,0,  451,.5,2670,.02,0,  131,1,1303,.1,0, .5);
	sdo=new FMO(213,1,.8,.1,0, 723,1,2912,.6,0, 140,1,800,.1,0,.3);
	hho=new FMO(2233,1,.5,.03,0, 423,1,3120,.07,2, 552,1,1800,.02,1,.7);
	cyo=new FMO(2612,1,.4,.4,0, 1826,1,4219,5,2, 3897,1,1401,1,2,.4);
	noise=new Noise(440,0.5,out);
	speech=new Speech();
//	bdo=new BOSC(0,2.0);
//	sdo=new BOSC(1,2.0);
//	hho=new BOSC(2,0.8);
	cmds=new Cmds();
	video=new Video();
	Resize();
	window.addEventListener("resize",Resize);
	window.document.addEventListener("keypress",KeyPress);
	window.document.addEventListener("keydown",KeyDown);
	window.document.addEventListener("mousemove",MouseEvent);
	window.document.addEventListener("mousedown",MouseEvent);
	window.document.addEventListener("mouseup",MouseEvent);
	Reset();
	cmds.message("LiveBeats initialized.");
	cmds.message("");
	if(window.xhrreqerr) {
		cmds.message("IR files cannot be loaded, 'master.ir' is desabled.");
		cmds.message("  May be connect with 'file:///'?");
		cmds.message("  Should be placed on WebServer and connect with http://");
	}
	lastTime=0;
	document.addEventListener("dragover",DragOver,false);
	document.addEventListener("drop",FileDrop,false);

	console.log("load plugins");
	var p=_LoadPlugin("vj_camformantgl","cam","base");
	p.obj.param.a.value=0;
	p=_LoadPlugin("vj_drop","p1","base");
	p.obj.param.a.value=0;
//	p=_LoadPlugin("vj_drop","p2","base");
//	p.obj.param.a.value=0;
	p=_LoadPlugin("vj_matrix","mat","base");
	p.obj.param.a.value=0;
	_LoadPlugin("vj_wave","wav","base");
	_LoadPlugin("vj_txt","txt","topmost");

	setTimeout(WaitReady,200);
//	setInterval(Interval,30);
//	setTimeout("CmdInit(location.search.slice(1).split('&'))",200);
}
function Resize() {
	scrWidth=document.body.clientWidth;
	scrHeight=window.innerHeight-20;
	var b=document.getElementById("base");
	b.style.width=scrWidth+"px";
	b.style.height=scrHeight+"px";
	b=document.getElementById("topmost");
	b.style.width=scrWidth+"px";
	b.style.height=scrHeight+"px";
//	cam.layout();
}
function MouseEvent(ev) {
	mouse.px=ev.x/scrWidth;
	mouse.py=1-ev.y/scrHeight;
	mouse.pz=ev.which;
}
function KeyDown(ev) {
	if(cmdlinemode)
		return;
	switch(ev.keyCode) {
	case 8:
		cmds.key(8);
		ev.preventDefault();
		ev.stopPropagation();
		return false;
	case 9:
		cmds.key(9);
		ev.preventDefault();
		ev.stopPropagation();
		return false;
	case 13:
		cmds.key(13);
		ev.preventDefault();
		return false;
	case 37:  //left
		cmds.key("l");
		ev.preventDefault();
		return false;
	case 38:  //up
		cmds.key("u");
		ev.preventDefault();
		return false;
	case 39:  //right
		cmds.key("r");
		ev.preventDefault();
		return false;
	case 40:  //down
		cmds.key("d");
		ev.preventDefault();
		return false;
	case 112:  //f1
		cmds.key("f1");
		ev.preventDefault();
		return false;
	case 113:  //f2
		cmds.key("f2");
		ev.preventDefault();
		return false;
	case 114:  //f3
		cmds.key("f3");
		ev.preventDefault();
		return false;
	case 115:  //f4
		cmds.key("f4");
		ev.preventDefault();
		return false;
	case 116:  //f5
		cmds.key("f5");
		ev.preventDefault();
		return false;
	case 117:  //f6
		cmds.key("f6");
		ev.preventDefault();
		return false;
	case 118:  //f7
		cmds.key("f7");
		ev.preventDefault();
		return false;
	case 119:  //f8
		cmds.key("f8");
		ev.preventDefault();
		return false;
	case 120:  //f9
		cmds.key("f9");
		ev.preventDefault();
		return false;
	case 121:  //f10
		cmds.key("f10");
		ev.preventDefault();
		return false;
	case 122:  //f11
		cmds.key("f11");
		ev.preventDefault();
		return false;
	case 123:  //f12
		break;
	}
}
function KeyPress(ev) {
	if(cmdlinemode)
		return;
	cmds.key(ev.charCode);
	ev.preventDefault();
	ev.stopPropagation();
	return false;
}
function Reset() {
	o1.step=o2.step=o3.step=o4.step=o5.step=o6.step=o7.step=o8.step=0;
//	o1.step=o2.step=o3.step=o4.step=o5.step=o6.step=0;
	bdo.step=sdo.step=hho.step=cyo.step=0;
//	bdo.step=sdo.step=hho.step=0;
	cnt=0;
	lfo1=lfo2=lfo4=lfo8=lfo16=lfo32=lfo48=lfo64=0;
	beat4=beat8=beat16=beat32=beat64=0;
}
function Enter(s) {
	var r="";
	if(s.indexOf("//")==0)
		return "";
	var n=0;
	for(var i=s.length-1;i>=0;--i)
		if(s[i]=="\"")
			++n;
	if(n&1)
		s+="\"";
	var ss=s.split(";");
	for(var idx=0;idx<ss.length;++idx) {
		s=ss[idx];
		r+=Enter1(s);
	}
	return r;
}
function oscdesc(o,nam) {
	var r;
	r=nam+".s (note):"+o.s+"\n";
	r+=nam+".g (gate):"+o.g+"\n";
	r+=nam+".v (volume):"+o.v+"\n";
	r+=nam+".f (freq):"+o.f+"\n";
	r+=nam+".c (cutoff):"+o.c+"\n";
	r+=nam+".q (Q):"+o.q+"\n";
	r+=nam+".d (decay):"+o.d+"\n";
	r+=nam+".porta:"+o.porta+"\n";
	r+=nam+".dist:"+o.dist+"\n";
	r+=nam+".delay:"+o.delay+"\n";
	r+=nam+".wav:"+o.wav+"\n";
	r+=nam+".type:"+o.type+"\n";
	r+=nam+".pan:"+o.pan+"\n";
	r+=nam+".out:"+o.out+"\n";
	return r;
}
function fmodesc(o,nam) {
	var r;
	r=nam+".s (step):"+o.s+"\n";
	r+=nam+".v (volume):"+o.v+"\n";
	r+=nam+".pan:"+o.pan;
	return r;
}
function Parse0(s) {
	function Parse1(l,r) {
		var o=null;
		var fmo=null;
		for(var i=0;i<plugins.length;++i) {
			var p=plugins[i];
			var pparam=pluginsparam[i];
			if(l.indexOf(p.name+".")==0) {
				var pname=l.substr(p.name.length+1);
				pparam[pname]=r;
			}
		}
		if(l.indexOf("bdo.")==0)
			fmo=bdo;
		else if(l.indexOf("sdo.")==0)
			fmo=sdo;
		else if(l.indexOf("hho.")==0)
			fmo=hho;
		else if(l.indexOf("cyo.")==0)
			fmo=cyo;
		if(fmo) {
			switch(l.substr(4)) {
			case "s": fmo.s=right; break;
			case "s+": fmo.s=streval(fmo.s)+streval(right); break;
			case "v": fmo.v=right; break;
			case "pan": fmo.pan=right; break;
			case "f1": fmo.f1=right; break;
			case "f2": fmo.f2=right; break;
			case "f3": fmo.f3=right; break;
			case "p1": fmo.p1=right; break;
			case "p2": fmo.p2=right; break;
			case "p3": fmo.p3=right; break;
			case "v1": fmo.v1=right; break;
			case "v2": fmo.v2=right; break;
			case "v3": fmo.v3=right; break;
			case "r1": fmo.r1=right; break;
			case "r2": fmo.r2=right; break;
			case "r3": fmo.r3=right; break;
			default: return "Property not found";
			}
			return null;
		}
		if(l[0]=="o" && l[2]==".") {
			switch(l[1]) {
			case "1": o=o1; break;
			case "2": o=o2; break;
			case "3": o=o3; break;
			case "4": o=o4; break;
			case "5": o=o5; break;
			case "6": o=o6; break;
			case "7": o=o7; break;
			case "8": o=o8; break;
			}
			if(o) {
				switch(l.substr(3)) {
				case "s": o.s=right; break;
				case "s+": o.s=streval(o.s)+streval(right); break;
				case "g": o.g=right; break;
				case "g+": o.g=streval(o.g)+streval(right); break;
				case "f": o.f=right; break;
				case "v": o.v=right; break;
				case "c": o.c=right; break;
				case "q": o.q=right; break;
				case "porta": o.porta=right; break;
				case "type": o.type=right; break;
				case "delay": o.delay=right; break;
				case "pan": o.pan=right; break;
				case "out": o.out=right; break;
				case "d": o.d=right; break;
				case "dist":o.dist=right; break;
				case "wav": o.wav=right; o.MakeWav(); break;
				default: return "Property not found";
				}
				return null;
			}
		}
		switch(l) {
		case "noise.v": noise.v=r; break;
		case "noise.s": noise.s=r; break;
		case "dmx.p0": dmx.p0=r; break;
		case "dmx.p1": dmx.p1=r; break;
		case "dmx.p2": dmx.p2=r; break;
		case "dmx.p3": dmx.p3=r; break;
		case "dmx.p4": dmx.p4=r; break;
		case "dmx.p5": dmx.p5=r; break;
		case "dmx.p6": dmx.p6=r; break;
		case "dmx.p7": dmx.p7=r; break;
		case "midi.port": midi.port=r; break;
		case "midi.pg": midioutputs[midi.port].send([0xc0,r]);
		case "video.src": video.Switch(numeval(r)); break;
		case "master.v": master.v=r; break;
		case "master.g": master.g=r; break;
		case "master.t": master.t=r; break;
		case "master.tempo": master.tempo=r; break;
		case "master.rev": master.rev=r; break;
		case "master.ir": master.ir=numeval(r);
			if(master.ir>=1){
				if(ir[master.ir-1])
					master.conv.buffer=ir[master.ir-1].data;
			}
			break;
		case "master.run": master.run=r; break;
		case "delay.t": delay.t=r; break;
		case "delay.fb": delay.fb=r; break;
		case "say.t": speech.SetText(r); break;
		case "say.r": speech.SetRate(r); break;
		case "say.p": speech.SetPitch(r); break;
		case "say.l": speech.SetLoop(r); break;
		case "say.lang": speech.SetLang(r); break;
		case "say.v": speech.SetVol(r); break;
		case "say.voice": speech.SetVoice(r); break;
		case "txt.a": cmds.a=r; break;
		case "txt.w": cmds.w=r; break;
		case "txt.h": cmds.h=r; break;
		case "txt.x": cmds.x=r; break;
		case "txt.y": cmds.y=r; break;
		case "txt.z": cmds.z=r; break;
		case "txt.rot": cmds.rot=r; break;
		case "txt.hue": cmds.hue=r; break;
		case "txt.eff": cmds.eff=r; break;
		case "txt.col": cmds.col=r; break;
		case "txt.bcol": cmds.bcol=r; break;
		default: return "Object not found";
		}
		return null;
	}
	var v=s.split("=");
	var right=v[v.length-1];
	var r;
	for(var i=v.length-2;i>=0;--i) {
		r=Parse1(v[i],right);
		if(r)
			break;
	}
	if(r)
		return r;
	else
		return right;
}
function GetUrl(){
	document.getElementById("urlpane").style.display="block";
	var s=location.href.split("?")[0]+"?";
	if(master.tempo!="120")
		s+="master.tempo="+encodeURIComponent(master.tempo)+"&";
	if(master.ir!=0)
		s+="master.ir="+encodeURIComponent(master.ir)+"&";
	if(master.g!="")
		s+="master.g="+encodeURIComponent(master.g)+"&";
	for(var i=1;i<=8;++i){
		var o=eval("o"+i);
		if(o.s!=o.defs)
			s+="o"+i+".s="+encodeURIComponent(o.s)+"&";
		if(o.f!=o.deff)
			s+="o"+i+".f="+encodeURIComponent(o.f)+"&";
		if(o.d!=o.defd)
			s+="o"+i+".d="+encodeURIComponent(o.d)+"&";
		if(o.q!=o.defq)
			s+="o"+i+".q="+encodeURIComponent(o.q)+"&";
		if(o.c!=o.defc)
			s+="o"+i+".c="+encodeURIComponent(o.c)+"&";
		if(o.v!=o.defv)
			s+="o"+i+".v="+encodeURIComponent(o.v)+"&";
		if(o.delay!=o.defdelay)
			s+="o"+i+".delay="+encodeURIComponent(o.delay)+"&";
		if(o.out!=o.defout)
			s+="o"+i+".out="+encodeURIComponent(o.out)+"&";
		if(o.pan!=o.defpan)
			s+="o"+i+".pan="+encodeURIComponent(o.pan)+"&";
		if(o.wav!=o.defwav)
			s+="o"+i+".wav="+encodeURIComponent(o.wav)+"&";
		if(o.type!=o.deftype)
			s+="o"+i+".type="+encodeURIComponent(o.type)+"&";
		if(o.porta!=o.defporta)
			s+="o"+i+".porta="+encodeURIComponent(o.porta)+"&";
	}
	var otab=["bdo","sdo","hho","cyo"];
	for(var i=0;i<4;++i){
		var o=eval(otab[i]);
		if(o.s)
			s+=otab[i]+".s="+encodeURIComponent(o.s)+"&";
	}
	for(var i=0,e=plugins.length;i<e;++i){
		var plug=plugins[i].obj;
		var plugparam=pluginsparam[i];
		for(var j in plugparam){
			if(plug.param[j] && plugparam[j]!=plug.param[j].defval)
				s+=plugins[i].name+"."+j+"="+encodeURIComponent(plugparam[j])+"&";
		}
	}
	document.getElementById("url").value=(s);
}
function Parse(str) {
	function isspc(p) {
		if(str[p]==" "||p>=str.length)
			return true;
		return false;
	}
	function skip(p) {
		while(p<str.length&&isspc(p))
			++p;
		return p;
	}
	function test(p,s) {
		if(str.indexOf(s,p)==p&&isspc(p+s.length))
			return true;
		return false;
	}
	var p=0;
	p=skip(p);
	if(test(p,"edit")){
		var s;
		var i=skip(p+4);
		s=replaceplugin(str.substr(i));
		try {
			s=eval(s)+"\n";
		} catch(e) {s="Undefined\n";}
		return str.substr(i)+"="+s+"\n";
/*		if(this.histcur<this.hist.length-1) {
			++this.histcur;
			this.log[0]=this.hist[this.histcur];
			this.cursor=this.log[0].length;
			this.dirty=1;
		}
		return "";
*/
	}
	if(test(p,"cmdline")){
		var el=document.getElementById("cmdline");
		if((cmdlinemode^=1)){
			el.style.display="block";
			el.focus();
		}
		else
			el.style.display="none";
	}
	if(test(p,"geturl")){
		GetUrl();
		return "";
	}
	if(test(p,"reload")){
		location.href=location.href;
	}
	if(test(p,"clear")) {
		cmds.log.length=0;
		return "";
	}
	if(test(p,"print")) {
		var s;
		p=skip(p+5);
		s=replaceplugin(str.substr(p));
		try {
			s=eval(s)+"\n";
		} catch(e) {s="Undefined\n";}
		return s;
	}
	if(test(p,"name")) {
		p=skip(p+4);
		return NamePlugin(str.substr(p));
	}
	if(test(p,"del")) {
		p=skip(p+3);
		return DeletePlugin(str.substr(p));
	}
	if(test(p,"load")) {
		p=skip(p+4);
		return LoadPlugin(str.substr(p));
	}
	if(test(p,"list")) {
		var r="";
		p=skip(p+4);
		if(test(p,"plugins")) {
			for(var i=0;i<plugins.length;++i) {
				r+=plugins[i].name+":"+plugins[i].script+"\n";
			}
			return r;
		}
		for(var i=0;i<plugins.length;++i) {
			if(test(p,plugins[i].name)) {
				r+=plugins[i].name+":\n";
				for(var j in plugins[i].obj.param) {
					r+=" "+j+":"+plugins[i].obj.param[j].value+"\n";
				}
				return r;
			}
		}
		if(test(p,"ir")) {
			for(var i=0;i<ir.length;++i) {
				r+=(i+1)+":"+ir[i].name+"\n";
			}
			return r;
		}
		if(test(p,"midi")) {
			for(var i=0;i<midioutputs.length;++i) {
				r+=(i+1)+":"+midioutputs[i].name+"\n";
			}
			return r;
		}
		if(test(p,"osc")) {
			r="o1.s:"+o1.s;
			r+="\no2.s:"+o2.s;
			r+="\no3.s:"+o3.s;
			r+="\no4.s:"+o4.s;
			r+="\no5.s:"+o5.s;
			r+="\no6.s:"+o6.s;
			r+="\no7.s:"+o7.s;
			r+="\no8.s:"+o8.s;
			r+="\n";
			return r;
		}
		if(test(p,"fmo")) {
			r="cyo.s:"+cyo.s;
			r+="\nhho.s:"+hho.s;
			r+="\nsdo.s:"+sdo.s;
			r+="\nbdo.s:"+bdo.s+"\n";
			return r;
		}
		if(test(p,"master")) {
			r="master.v (volume):"+master.v+"\n";
			r+="master.g (gate):"+master.g+"\n";
			r+="master.tempo:"+master.tempo+"\n";
			r+="master.rev:"+master.rev+"\n";
			r+="master.ir:"+master.ir+"\n";
			return r;
		}
		if(test(p,"delay")) {
			r="delay.t (time):"+delay.t+"\n";
			r+="delay.fb (feedback):"+delay.fb+"\n";
			return r;
		}
		if(test(p,"o1"))
			return oscdesc(o1,"o1");
		if(test(p,"o2"))
			return oscdesc(o2,"o2");
		if(test(p,"o3"))
			return oscdesc(o3,"o3");
		if(test(p,"o4"))
			return oscdesc(o4,"o4");
		if(test(p,"o5"))
			return oscdesc(o5,"o5");
		if(test(p,"o6"))
			return oscdesc(o6,"o6");
		if(test(p,"o7"))
			return oscdesc(o7,"o7");
		if(test(p,"o8"))
			return oscdesc(o8,"o8");
		if(test(p,"bdo"))
			return fmodesc(bdo,"bdo");
		if(test(p,"sdo"))
			return fmodesc(sdo,"sdo");
		if(test(p,"hho"))
			return fmodesc(hho,"hho");
		if(test(p,"cyo"))
			return fmodesc(cyo,"cyo");
		r="";
		r+="--builtin--\n";
		r+="master, delay\n";
		r+="osc:o1 o2 o3 o4 o5 o6 o7 o8\n";
		r+="fmo:bdo sdo hho cyo\n";
		r+="--variables--\ns0-s24:pre-defined sequence\ntick:currentTick\nlev:currentLevel\nsh8/16/32/64: S&H/(n)tick\n";
		r+="lfo8/16/32/64: LFO (n)tick\n";
		r+="--functions--\nhue(h), hsv(h,s,v): for colorString\nlfo(n): (n)tickLFO\n";
		r+="--plugins--\ncam,wav,mat,txt\n";
		return r;
	}
	return null;
}
function Enter1(s) {
	var v=Parse(s);
	if(v!==null)
		return v;
	return Parse0(s);
}
function Mml(s) {
	function GetN(def) {
		var v=0;
		while(s[p]>="0"&&s[p]<="9") {
			v=v*10+s[p];
			++p;
		}
		if(v==0)
			return def;
		return v;
	}
	function GetLen(def) {
		var l=16/GetN(def);
		var l2=l;
		while(s[p]==".") {
			++p;
			l2/=2;
			l+=l2;
		}
		return l;
	}
	function Shift(n) {
		for(;;) {
			switch(s[p]) {
			case "+": case "#":
				++p;
				++n;
				break;
			case "-":
				++p;
				--n;
			default:
				return n;
			}
		}
	}
	var r=[];
	var len=s.length;
	var p=0;
	var n=0;
	var o=4;
	var l=0;
	var defl=16;
	while(p<len) {
		l=0;
		switch(s[p]) {
		case ">":
			++p;
			--o;
			break;
		case "<":
			++p;
			++o;
			break;
		case "O": case "o":
			++p;
			o=GetN(4);
			break;
		case "L": case "l":
			++p;
			defl=GetN(16);
			break;
		case "R": case "r":
			++p;
			n=0;
			l=GetLen(defl);
			break;
		case "C": case "c":
			++p;
			n=Shift(o*12);
			l=GetLen(defl);
			break;
		case "D": case "d":
			++p;
			n=Shift(o*12+2);
			l=GetLen(defl);
			break;
		case "E": case "e":
			++p;
			n=Shift(o*12+4);
			l=GetLen(defl);
			break;
		case "F": case "f":
			++p;
			n=Shift(o*12+5);
			l=GetLen(defl);
			break;
		case "G": case "g":
			++p;
			n=Shift(o*12+7);
			l=GetLen(defl);
			break;
		case "A": case "a":
			++p;
			n=Shift(o*12+9);
			l=GetLen(defl);
			break;
		case "B": case "b":
			++p;
			n=Shift(o*12+11);
			l=GetLen(defl);
			break;
		default:
			++p;
		}
		for(var i=0;i<l;++i)
			r.push(n);
	}
	if(r.length==0)
		return [0];
	return r;
}
function Timecode(t) {
	var hh=(t/3600)|0;
	t-=hh*3600;
	var mm=(t/60)|0;
	t-=mm*60;
	var ss=t|0;
	var ff=((t-ss)*30)|0;
	return ("00"+hh).substr(-2)+":"+("00"+mm).substr(-2)+":"+("00"+ss).substr(-2);
//	return ("00"+hh).substr(-2)+":"+("00"+mm).substr(-2)+":"+("00"+ss).substr(-2)+":"+("00"+ff).substr(-2);
}
function Automation_None(actx,param,v,t){
	this.param=param;
	this.cancelScheduledValues=function(t){
		this.param.cancelScheduledValues(t);
	};
	this.setValueAtTime=function(v,t){
		this.param.setValueAtTime(v,t);
	};
	this.linearRampToValueAtTime=function(v,t){
		this.param.linearRampToValueAtTime(v,t);
	};
	this.setTargetAtTime=function(v,t,c){
		this.param.setTargetAtTime(v,t,c);
	};
}
function CmdlineInput(){
	var s=document.getElementById("cmdline").value;
	document.getElementById("cmdline").value="";
	cmds.message("> "+s);
	Enter(s);
}
function Automation(actx,param,v,t){
	this.actx=actx;
	this.param=param;
	this.cmdbuf=[];
	this.cnt=0;
	this.Cancel=function(){
		while(this.cmdbuf.length && this.actx.currentTime>this.cmdbuf[0][2])
			this.cmdbuf.shift();
	};
	this.Reque=function(){
		if(this.cnt++<1000)
			return;
		this.cnt=0;
		this.param.cancelScheduledValues(0);
		for(var i=0,l=this.cmdbuf.length;i<l;++i){
			var buf=this.cmdbuf[i];
			switch(buf[0]){
			case 0:
				this.param.setValueAtTime(buf[1],buf[2]);
				break;
			case 1:
				this.param.linearRampToValueAtTime(buf[1],buf[2]);
				break;
			case 2:
				this.param.exponentialRampToValueAtTime(buf[1],buf[2]);
				break;
			case 3:
				this.param.setTargetAtTime(buf[1],buf[2],buf[3]);
				break;
			}
		}
	};
	this.cancelScheduledValues=function(t){
		this.param.cancelScheduledValues(t);
	};
	this.setValueAtTime=function(v,t){
		this.Cancel();
		this.cmdbuf.push([0,v,t]);
		this.param.setValueAtTime(v,t);
		this.Reque();
	};
	this.linearRampToValueAtTime=function(v,t){
		this.Cancel();
		this.cmdbuf.push([1,v,t]);
		this.param.linearRampToValueAtTime(v,t);
		this.Reque();
	};
	this.exponentialRampToValueAtTime=function(v,t){
		this.Cancel();
		this.cmdbuf.push([2,v,t]);
		this.exponentialRampToValueAtTime(v,t);
		this.Reque();
	};
	this.setTargetAtTime=function(v,t,c){
		this.Cancel();
		this.cmdbuf.push([3,v,t,c]);
		this.param.setTargetAtTime(v,t,c);
		this.Reque();
	};
}
function Interval() {
	var current=audioctx.currentTime;
	var err;
	animInterval(current*1000);
	while(current>=nextTime-.2) {
		++tick;
		var c4=tick&3;
		var c8=tick&7;
		var c16=tick&15;
		var c32=tick&31;
		var c64=tick&63;
		var c96=tick%96;
		var c128=tick&127;
		++cnt;
		lfo2=cnt&1;
		lfo4=((c4>2)?4-c4:c4)*.5;
		lfo8=((c8>4)?8-c8:c8)*.25;
		lfo16=((c16>8)?16-c16:c16)*.125;
		lfo32=((c32>16)?32-c32:c32)*.0625;
		lfo64=((c64>32)?64-c64:c64)*.03125;
		lfo96=((c96>48)?96-c96:c96)/48;
		lfo128=((c128>64)?128-c128:c128)*.015625;
		sh1=Math.random();
		if((tick&1)==0) sh2=Math.random();
		if(c4==0) sh4=Math.random();
		if(c8==0) sh8=Math.random();
		if(c16==0) sh16=Math.random();
		if(c32==0) sh32=Math.random();
		if(c64==0) sh64=Math.random();
		if(c96==0) sh96=Math.random();
		if(c128==0) sh128=Math.random();
		beat4=(c4==0?1:0);
		beat8=(c8==0?1:0);
		beat16=(c16==0?1:0);
		beat32=(c32==0?1:0);
		beat64=(c64==0?1:0);
		master.next(nextTime);
		bdo.next(nextTime);
		sdo.next(nextTime);
		hho.next(nextTime);
		cyo.next(nextTime);
		o1.next(nextTime);
		o2.next(nextTime);
		o3.next(nextTime);
		o4.next(nextTime);
		o5.next(nextTime);
		o6.next(nextTime);
		o7.next(nextTime);
		o8.next(nextTime);
		delay.next(nextTime);
		speech.next(nextTime);
		dmx.next(nextTime);
		noise.next(nextTime);
		if(nextTime==0)
			nextTime=current;
		nextTime+=15/master._tempo;
	}
}
function lfo(t) {
	var l=t|0;
	var l2=l/2;
	var p=tick%l;
	p=(p>=l2)?l-p:p;
	return p/l2;
}
function hsv(h,s,v) {
	h=h-(h|0);
	if(s>1) s=s-(s|0);
	if(v>1) v=v-(v|0);
	var r=v,g=v,b=v;
	if(s>0) {
		h*=6.0;
		var hh=h|0;
		var f=h-hh;
		var r,g,b;
		switch(hh) {
		case 0:
			g=v-v*s*(1-f);
			b=v-v*s;
			break;
		case 1:
			r=v-v*s*f;
			b=v-v*s;
			break;
		case 2:
			r=v-v*s;
			b=v-v*s*(1-f);
			break;
		case 3:
			r=v-v*s;
			g=v-v*s*f;
			break;
		case 4:
			r=v-v*s*(1-f);
			g=v-v*s;
			break;
		case 5:
			g=v-v*s;
			b=v-v*s*f;
			break;
		}
	}
	return "rgb("+(r*255|0)+","+(g*255|0)+","+(b*255|0)+")";
}
function hue(h) {
	h-=(h|0);
	var t=h*6;
	var r=g=b=0;
	if(t<1) {
		r=255;
		g=(t*255)|0;
		b=0;
	}
	else if(t<2) {
		r=((2-t)*255)|0;
		g=255;
		b=0;
	}
	else if(t<3) {
		r=0;
		g=255;
		b=((t-2)*255)|0;
	}
	else if(t<4) {
		r=0;
		g=((4-t)*255)|0;
		b=255;
	}
	else if(t<5) {
		r=((t-4)*255)|0;
		g=0;
		b=255;
	}
	else {
		r=255;
		g=0;
		b=((6-t)*255)|0;
	}
	return "rgb("+r+","+g+","+b+")";
}
function replaceplugin(s) {
	if(typeof(s)=="string") {
		for(var i=0;i<plugins.length;++i) {
			s=s.replace(new RegExp(plugins[i].name+"\.([a-z]*)","g"),"plugins["+i+"].obj.param.$1.value");
		}
	}
	return s;
}
function streval(s) {
	if(s=="s") return s;
	if(s=="l") return s;
	var l=s;
	for(;;) {
		if(typeof(s)=="string") {
			l=s;
			try {
				s=eval(s);
			} catch(e) {return l;}
		}
		else
			return l;
	}
}
function numeval(s) {
	try {
		for(;;) {
			var t=typeof(s);
			switch(t) {
			case "number":
				return s;
			case "string":
				s=eval(replaceplugin(s));
				break;
			default:
				return 0;
			}
		}
	} catch(e) {return 0;}
}
function Note2Vol(n) {
	n-=48;
	if(n<0)
		return 0;
	return 2/(n+2);
}
function LightCol(h){
  var r,g,b;
  var n=h*6;
  var nn=n|0;
  n=((n-nn)*127)|0;
  nn%=6;
  switch(nn){
  case 0: r=127,g=n,b=0; break;
  case 1: r=127-n,g=127,b=0; break;
  case 2: r=0,g=127,b=n; break;
  case 3: r=0,g=127-n,b=127; break;
  case 4: r=n,g=0,b=127; break;
  case 5: r=127,g=0,b=127-n; break;
  }
  return [r,g,b];
}
function DMX(){
	this.hue=0;
	this.p0="0";
	this.p1="0";
	this.p2="0";
	this.p3="0";
	this.p4="0";
	this.p5="0";
	this.p6="0";
	this.p7="0";
	this.next=function(t) {
		if(dmxout==null)
			return;
		var now=performance.now();
		var dmxdelay=200;
		var v0=this.p0[tick%this.p0.length];
		var v1=this.p1[tick%this.p1.length];
		var v2=this.p2[tick%this.p2.length];
		var v3=this.p3[tick%this.p3.length];
		var v4=this.p4[tick%this.p4.length];
		var v5=this.p5[tick%this.p5.length];
		var v6=this.p6[tick%this.p6.length];
		var v7=this.p7[tick%this.p7.length];
		if(v0>"a") v0=(v0.charCodeAt(0)-0x61)*127/25; else v0=v0*127/9;
		if(v1>"a") v1=(v1.charCodeAt(0)-0x61)*127/25; else v1=v1*127/9;
		if(v2>"a") v2=(v2.charCodeAt(0)-0x61)*127/25; else v2=v2*127/9;
		if(v3>"a") v3=(v3.charCodeAt(0)-0x61)*127/25; else v3=v3*127/9;
		if(v4>"a") v4=(v4.charCodeAt(0)-0x61)*127/25; else v4=v4*127/9;
		if(v5>"a") v5=(v5.charCodeAt(0)-0x61)*127/25; else v5=v5*127/9;
		if(v6>"a") v6=(v6.charCodeAt(0)-0x61)*127/25; else v6=v6*127/9;
		if(v7>"a") v7=(v7.charCodeAt(0)-0x61)*127/25; else v7=v7*127/9;
		dmxout.send([0xb0,0,v0],now+dmxdelay);
		dmxout.send([0xb0,1,v1],now+dmxdelay);
		dmxout.send([0xb0,2,v2],now+dmxdelay);
		dmxout.send([0xb0,3,v3],now+dmxdelay);
		dmxout.send([0xb0,4,v4],now+dmxdelay);
		dmxout.send([0xb0,5,v5],now+dmxdelay);
		dmxout.send([0xb0,6,v6],now+dmxdelay);
		dmxout.send([0xb0,7,v7],now+dmxdelay);
	}
}
function Noise(f,v,to){
	this.rdist=0;
	this.ena=0;
	this.form={0:"sine",1:"sawtooth",2:"square"};
	this.Source=audioctx.createBufferSource();
	this.Source.loop=true;
	this.Buf=audioctx.createBuffer(1,44100,44100);
	const d=this.Buf.getChannelData(0);
	for(let i=0;i<44100;++i){
		d[i]=Math.random()-0.5;
	}
	this.Source.buffer=this.Buf;

	this.Fil=audioctx.createBiquadFilter();
	this.FilFrequency=new Automation(audioctx,this.Fil.frequency);
	this.FilDetune=new Automation(audioctx,this.Fil.detune);
	this.Gain=audioctx.createGain();
	this.GainGain=new Automation(audioctx,this.Gain.gain);
	this.Mod=audioctx.createGain();
	this.Send=audioctx.createGain();
	this.Pan=audioctx.createStereoPanner();
	this.Source.connect(this.Fil);
	this.Fil.connect(this.Gain);
	this.Gain.connect(this.Mod);
	this.Gain.connect(this.Send);
	this.Gain.connect(this.Pan);
	this.Send.connect(delay.Dly);
	this.Gain.gain.value=0;
	this.Send.gain.value=0;
	this.Mod.gain.value=1200;
	if(to) {
		this.Pan.connect(to);
	}
	this.s=this.defs="";
	this.g=this.defg="c";
//	this.type=this.deftype=t;
	this.c=this.defc=20;
	this.q=this.defq=10;
	this.v=this.defv=v;
	this.porta=this.defporta=0;
	this.pan=this.defpan=0.5;
	this.out=this.defout="master";
	this.delay=this.defdelay=0.0;
	this.f=this.deff=f;
	this.d=this.defd=1;
	this.dist=this.defdist=0;
	this.step=0;
	this._out=null;
	this.freq="";
	this.Source.start(0);
	this.tune=0;
	this.next=function(t) {
		this.Send.gain.value=numeval(this.delay);
		var s=Mml(streval(this.s));
		this.step=tick%s.length;
		var tune=s[this.step];
		var v=1;//Note2Vol(g[tick%g.length]);
		if(this._out!=this.out) {
			this._out=this.out;
			this.Pan.disconnect();
			this.Mod.disconnect();
			if(this._out=="master")
				this.Pan.connect(master.out);
			else {
				this.Gain.connect(this.Mod);
				try {
					this.Mod.connect(eval(this.out).Osc.frequency);
				} catch(e) {}
			}
		}
		if(tune) {
			tune=(tune-57+master.tunparam-5)*100;
//			this.OscDetune.setTargetAtTime(tune,t,Math.pow(100,numeval(this.porta))*.001);
			this.FilDetune.setValueAtTime(tune,t);
			var _freq=numeval(this.f);
//			this.OscFrequency.setTargetAtTime(_freq,t,Math.pow(100,numeval(this.porta))*.001);
			var _cutoff=numeval(this.c);
			this.FilFrequency.setValueAtTime(_freq*_cutoff,t);
			this.Fil.Q.value=numeval(this.q);
			this.GainGain.setTargetAtTime(numeval(this.v)*v*.6,t,0.001);
			var d=Math.max(0.02,numeval(this.d));
			if(d<1)
				this.GainGain.setTargetAtTime(0,t+0.01,d);
			this.tune=tune;
		}
		else {
			this.GainGain.setTargetAtTime(0,t,0.01);
		}
		this.Pan.pan.value=(numeval(this.pan)-0.5)*2;
	}
}
function OSC(f,v,t,to) {
	this.MakeWav=function(){
		for(var i=0;i<32;++i){
			var c=this.wav[i];
			if(c>=0&&c<=9)
				this.custom[1][i+1]=parseFloat(this.wav[i]);
			else
				this.custom[1][i+1]=0;
		}
		this.periodic=audioctx.createPeriodicWave(this.custom[0],this.custom[1]);
	};
	this.rdist=0;
	this.MakeCurve=function(){
		var v=numeval(this.dist);
		for(var i=0;i<16;++i){
			k=i/15*(v*10+1);
			for(;;){
				if(k>1) k=2-k;
				else if(k<0) k=-k;
				else break;
			}
			this.curve[15+i]=k;
			this.curve[15-i]=-k;
		}
/*		var dist=Math.min(.99,numeval(this.dist));
		var peak=1-dist*.5;
		var v=(.01+dist)*100;
		for(var i=0;i<16;++i){
			var c=i/15;
			var k=Math.min(1,c*v);
			this.curve[15+i]=(k+(1-k)*c)*peak;
			this.curve[15-i]=(-k-(1-k)*c)*peak;
		}
*/
//		if(this.rdist!=this.dist){
//			this.rdist=this.dist;
//			console.log(this.curve);
//		}
	};
	this.ena=0;
	this.wav=this.defwav="10000001";
	this.custom=[];
	this.custom[0]=new Float32Array(33);
	this.custom[1]=new Float32Array(33);
	for(var i=0;i<9;++i)
		this.custom[0][i]=this.custom[1][i]=0.;
	this.MakeWav();
	this.form={0:"sine",1:"sawtooth",2:"square"};
	this.Osc=audioctx.createOscillator();
	this.OscDetune=new Automation(audioctx,this.Osc.detune);
	this.OscFrequency=new Automation(audioctx,this.Osc.frequency);
	this.Fil=audioctx.createBiquadFilter();
	this.FilFrequency=new Automation(audioctx,this.Fil.frequency);
	this.FilDetune=new Automation(audioctx,this.Fil.detune);
	this.Gain=audioctx.createGain();
	this.GainGain=new Automation(audioctx,this.Gain.gain);
	this.Shaper=audioctx.createWaveShaper();
	this.curve=new Float32Array(31);
	this.Shaper.curve=this.curve;
	this.Mod=audioctx.createGain();
	this.Send=audioctx.createGain();
	this.Pan=audioctx.createStereoPanner();
//	this.Osc.connect(this.Shaper);
//	this.Shaper.connect(this.Fil);
	this.Osc.connect(this.Fil);
	this.Fil.connect(this.Gain);
	this.Gain.connect(this.Mod);
	this.Gain.connect(this.Send);
	this.Gain.connect(this.Pan);
	this.Send.connect(delay.Dly);
	this.Gain.gain.value=0;
	this.Send.gain.value=0;
	this.Mod.gain.value=1200;
	if(to) {
		this.Pan.connect(to);
	}
	this.s=this.defs="";
	this.g=this.defg="c";
	this.type=this.deftype=t;
	this.c=this.defc=20;
	this.q=this.defq=10;
	this.v=this.defv=v;
	this.porta=this.defporta=0;
	this.pan=this.defpan=0.5;
	this.out=this.defout="master";
	this.delay=this.defdelay=0.0;
	this.f=this.deff=f;
	this.d=this.defd=1;
	this.dist=this.defdist=0;
	this.step=0;
	this._out=null;
	this.freq="";
	this.Osc.start(0);
	this.tune=0;
	this.next=function(t) {
		this.Send.gain.value=numeval(this.delay);
		var ty=numeval(this.type);
		if(ty<3)
			this.Osc.type=this.form[ty];
		else
			this.Osc.setPeriodicWave(this.periodic);
		var s=Mml(streval(this.s));
		this.step=tick%s.length;
		var tune=s[this.step];
//		var g=Mml(streval(this.g));
		var v=1;//Note2Vol(g[tick%g.length]);
		if(this._out!=this.out) {
			this._out=this.out;
			this.Pan.disconnect();
			this.Mod.disconnect();
			if(this._out=="master")
				this.Pan.connect(master.out);
			else {
				this.Gain.connect(this.Mod);
				try {
					this.Mod.connect(eval(this.out).Osc.frequency);
				} catch(e) {}
			}
		}
		if(tune) {
			this.MakeCurve();
			tune=(tune-57+master.tunparam-5)*100;
			this.OscDetune.setTargetAtTime(tune,t,Math.pow(100,numeval(this.porta))*.001);
			this.FilDetune.setValueAtTime(tune,t);
			var _freq=numeval(this.f);
//			this.OscFrequency.setValueAtTime(_freq,t);
			this.OscFrequency.setTargetAtTime(_freq,t,Math.pow(100,numeval(this.porta))*.001);
			var _cutoff=numeval(this.c);
			this.FilFrequency.setValueAtTime(_freq*_cutoff,t);
			this.Fil.Q.value=numeval(this.q);
			this.GainGain.setTargetAtTime(numeval(this.v)*v*.6,t,0.001);
			var d=Math.max(0.02,numeval(this.d));
			if(d<1)
				this.GainGain.setTargetAtTime(0,t+0.01,d);
			this.tune=tune;
		}
		else {
			this.GainGain.setTargetAtTime(0,t,0.01);
		}
		this.Pan.pan.value=(numeval(this.pan)-0.5)*2;
	}
}
function FMO(f1,p1,v1,r1,t1,f2,p2,v2,r2,t2,f3,p3,v3,r3,t3,pan) {
	this.Op1=audioctx.createOscillator();
	this.Op1gain=audioctx.createGain();
	this.Op2=audioctx.createOscillator();
	this.Op2gain=audioctx.createGain();
	this.Op3=audioctx.createOscillator();
	this.Op3gain=audioctx.createGain();
	this.Pan=audioctx.createStereoPanner();
	this.form={0:"sine",1:"sawtooth",2:"square"};

	this.Op3.connect(this.Op3gain);
	this.Op3gain.connect(this.Op2.frequency);
	this.Op2.connect(this.Op2gain);
	this.Op2gain.connect(this.Op1.frequency);
	this.Op1.connect(this.Op1gain);
	this.Op1gain.connect(this.Pan);
	this.Pan.connect(master.out);
	this.Op1gain.gain.value=0;
	this.s="";
	this.step=0;
	this.f1=this.deff1=f1;
	this.p1=this.defp1=p1;
	this._v=this.v=this.defv=v1;
	this.r1=this.defr1=r1;
	this.f2=f2;
	this.p2=p2;
	this.v2=v2;
	this.r2=r2;
	this.f3=f3;
	this.p3=p3;
	this.v3=v3;
	this.r3=r3;
	this.pan=pan;
	this.Op1.start(0);
	this.Op2.start(0);
	this.Op3.start(0);
	this.Op1.frequency.value=f1;
	this.Op2.frequency.value=f2;
	this.Op3.frequency.value=f3;
	this.Op1.type=this.form[t1];
	this.Op2.type=this.form[t2];
	this.Op3.type=this.form[t3];
	this.Op1gaingain=new Automation(audioctx,this.Op1gain.gain);
	this.Op2gaingain=new Automation(audioctx,this.Op2gain.gain);
	this.Op3gaingain=new Automation(audioctx,this.Op3gain.gain);
	this.Op1frequency=new Automation(audioctx,this.Op1.frequency);
	this.Op2frequency=new Automation(audioctx,this.Op2.frequency);
	this.Op3frequency=new Automation(audioctx,this.Op3.frequency);
/*	this.trig=function(t) {
		this.Op1gain.gain.cancelScheduledValues(t);
//		this.Op1gain.gain.setValueAtTime(0,t);
//		this.Op1gain.linearRampToValueAtTime(this.v[i],t+0.005);
		this.Op1gain.setValueAtTime(this.v[i],t);
		this.Op1gain.gain.linearRampToValueAtTime(0,t+0.006+this.h*0.075);
	}*/
	this.trig=function(t) {
//		this.Op1gaingain.cancelScheduledValues(t);
//		this.Op2gaingain.cancelScheduledValues(t);
//		this.Op3gaingain.cancelScheduledValues(t);
//		this.Op1frequency.cancelScheduledValues(t);
//		this.Op2frequency.cancelScheduledValues(t);
		this.Op1gaingain.setValueAtTime(0,t);
		this.Op1gaingain.linearRampToValueAtTime(this._v,t+0.001);
		this.Op2gaingain.setValueAtTime(this.v2,t);
		this.Op3gaingain.setValueAtTime(this.v3,t);
		this.Op1frequency.setValueAtTime(this.f1,t);
		this.Op2frequency.setValueAtTime(this.f2,t);
		this.Op1gaingain.setTargetAtTime(0,t+0.01,this.r1);
		this.Op2gaingain.setTargetAtTime(0,t+0.01,this.r2);
		this.Op3gaingain.setTargetAtTime(0,t+0.01,this.r3);
		this.Op1frequency.setTargetAtTime(this.f1*this.p1,t+0.011,this.r1);
		this.Op2frequency.setTargetAtTime(this.f2*this.p2,t+0.011,this.r2);
		this.Op3frequency.setTargetAtTime(this.f3*this.p3,t+0.011,this.r3);
//		this.Op1gaingain.linearRampToValueAtTime(0,t+0.06+this.r1);
//		this.Op2gaingain.linearRampToValueAtTime(0,t+0.06+this.r2);
//		this.Op3gaingain.linearRampToValueAtTime(0,t+0.06+this.r3);
	}
	this.next=function(t) {
		var s=Mml(streval(this.s));
		this.step=tick%s.length;
		var c=s[this.step];
		this._v=numeval(this.v);
		if(c) {
			var n=(c-48)*100;
			this.Op1.detune.value=n;
			this.trig(t);
		}
		this.Pan.pan.value=(this.pan-0.5)*2;
	}
}
function BOSC(n,v){
	this.s="r";
	this.step=0;
	this.bufnum=n;
	this.gain=audioctx.createGain();
	this.gaingain=new Automation(audioctx,this.gain.gain);
	this.gain.connect(master.out);
	this.gain.gain.value=this._v=this.v=v;
	this.trig=function(t) {
		var bufsrc=audioctx.createBufferSource();
		if(shot[this.bufnum]){
			bufsrc.buffer=shot[this.bufnum].data;
			bufsrc.connect(this.gain);
			bufsrc.start(t);
			this.gaingain.setValueAtTime(this._v,t);
		}
	}
	this.next=function(t) {
		var s=Mml(streval(this.s));
		this.step=tick%s.length;
		var c=s[this.step];
		this._v=numeval(this.v);
		if(c) {
			this.trig(t);
		}
//		this.Pan.pan.value=(this.pan-0.5)*2;
	}
}
function Master() {
	this.loadcnt=0;
	function GetName(s) {
		var p=s.lastIndexOf("/");
		return s.substr(p+1);
	}
	this.LoadSample=function(buf,n,url) {
		++this.loadcnt;
		var req = new XMLHttpRequest();
		req.open("GET", url, true);
		req.responseType = "arraybuffer";
		req.nam=GetName(url);
		req.master=this;
		req.onload = function() {
			if(req.response) {
				audioctx.decodeAudioData(req.response,function(b){buf[n]={"name":req.nam,"data":b};--req.master.loadcnt;},function(){});
			}
		}
		req.onerror=function() {
			window.xhrreqerr=true;
			--req.master.loadcnt;
		}
		try {req.send();} catch(e){}
	}
	this.LoadSample(ir,0,"samples/IMreverbs1/Five Columns Long.wav");
	this.LoadSample(ir,1,"samples/IMreverbs1/Five Columns.wav");
	this.LoadSample(ir,2,"samples/IMreverbs1/French 18th Century Salon.wav");
	this.LoadSample(ir,3,"samples/IMreverbs1/Going Home.wav");
	this.LoadSample(ir,4,"samples/IMreverbs1/In The Silo Revised.wav");
	this.LoadSample(ir,5,"samples/IMreverbs1/Narrow Bumpy Space.wav");
	this.LoadSample(ir,6,"samples/IMreverbs1/Nice Drum Room.wav");
	this.LoadSample(ir,7,"samples/IMreverbs1/Parking Garage.wav");
	this.LoadSample(ir,8,"samples/IMreverbs1/Rays.wav");
	this.LoadSample(ir,9,"samples/IMreverbs1/Trig Room.wav");
//	LoadSample(shot,0,"samples/kick.wav");
//	LoadSample(shot,1,"samples/snare.wav");
//	LoadSample(shot,2,"samples/chh.wav");

	this._v=(this.v=1.0)*.3;
	this.fade=.1;
	this.conv=audioctx.createConvolver();
	this.convgain=audioctx.createGain();
	this.comp=audioctx.createDynamicsCompressor();
	this.out=audioctx.createDelay();
	this.gain=audioctx.createGain();
	this.gain.gain=1;
	this.delaylfo=audioctx.createOscillator();
	this.delaylfo.frequency.value=55;
	this.delaylfofrequency=new Automation(audioctx,this.delaylfo.frequency);
	this.delaylfo.start(0);
	this.delaylfogain=audioctx.createGain();
	this.delaylfogain.gain.value=0;
	this.delaylfo.connect(this.delaylfogain);
	this.delaylfogain.connect(this.out.delayTime);
	this.delaylfogaingain=new Automation(audioctx,this.delaylfogain.gain);
	this.outdelay=new Automation(audioctx,this.out.delayTime);
	this.gaingain=new Automation(audioctx,this.gain.gain);
	this.ana=audioctx.createAnalyser();
	this.ana.fftSize=1024;
	this.out.connect(this.gain);
	this.gain.connect(this.conv);
	this.gain.connect(this.comp);
	this.conv.connect(this.convgain);
	this.convgain.connect(this.comp);
	this.comp.connect(audioctx.destination);
	this.comp.connect(this.ana);
	this.tccnt=0;
	this.g="";
	this.t="5";
	this.ir=0;
	this._rev=this.rev=.5;
	this._tempo=this.tempo=120;
	this.step=0;
	this.run=1;
	this.stepg=0;
	this.stept=0;
	this.next=function(t) {
		this._tempo=numeval(this.tempo);
		var stepg=((tick/4)|0);
		var stept=((tick/16)|0);
		var fsuparam=this.g[stepg%this.g.length];
		this.tunparam=parseInt(this.t[stept%this.t.length]);
		if(isNaN(this.tunparam))
			this.tunparam=5;
		var _v=numeval(this.v)*.3;
		this._rev=numeval(this.rev);
		this.convgain.gain.value=this._rev;
		this._v+=(_v-this._v)*this.fade;
		var p0=15/this._tempo;
		if(stepg!=this.stepg){
			this.stepg=stepg;
			switch(fsuparam){
			case "p":
				break;
			}
		}
		switch(fsuparam){
		case "1":
			this.delaylfogaingain.setValueAtTime(0,t);
			this.outdelay.setValueAtTime((tick&3)*p0,t);
			this.gaingain.setValueAtTime(this._v,t);
			this.gaingain.setTargetAtTime(0,t+p0*.5,0.01);
			break;
		case "2":
			this.delaylfogaingain.setValueAtTime(0,t);
			this.outdelay.setValueAtTime(0,t);
			this.gaingain.setValueAtTime(this._v,t);
			this.gaingain.setTargetAtTime(0,t+p0*.5,0.01);
			break;
		case "3":
			this.delaylfogaingain.setValueAtTime(0,t);
			this.outdelay.setValueAtTime((tick&3)*p0,t);
			this.outdelay.setValueAtTime((tick&3)*p0+p0*.5,t+p0*.5);
			this.gaingain.setValueAtTime(this._v,t);
			break;
		case "4":
			this.delaylfogaingain.setValueAtTime(0,t);
			this.outdelay.setValueAtTime((3-(tick&3))*p0,t);
			this.outdelay.setValueAtTime((3-(tick&3))*p0+p0*.5,t+p0*.5);
			this.gaingain.setValueAtTime(this._v,t);
			break;
		case "5":
			this.delaylfofrequency.setValueAtTime(55,t);
			this.delaylfogaingain.setValueAtTime(.01,t);
			this.outdelay.setValueAtTime(p0,t);
			this.gaingain.setValueAtTime(this._v,t);
			break;
		case "6":
			this.delaylfofrequency.setValueAtTime(880,t);
			this.delaylfogaingain.setValueAtTime(.01,t);
			this.outdelay.setValueAtTime(p0,t);
			this.gaingain.setValueAtTime(this._v,t);
			break;
		case "7":
			this.outdelay.setValueAtTime((tick&3)*p0,t);
			this.delaylfofrequency.setValueAtTime(10,t);
			this.delaylfogaingain.setValueAtTime(.01,t);
			this.gaingain.setValueAtTime(this._v,t);
			break;
		case "8":
			this.delaylfogaingain.setValueAtTime(0,t);
			this.delaylfofrequency.setValueAtTime(10,t);
			this.outdelay.setValueAtTime((tick&3)*p0,t);
			this.gaingain.setValueAtTime(this._v,t);
			this.gaingain.setTargetAtTime(0,t+p0*.5,0.01);
			this.delaylfogaingain.setValueAtTime(.1*(tick&2),t);
			break;
		case "9":
			this.delaylfogaingain.setValueAtTime(0,t);
			this.delaylfofrequency.setValueAtTime(1,t);
			this.outdelay.setValueAtTime((tick&3)*p0,t);
			this.gaingain.setValueAtTime(this._v,t);
			this.gaingain.setTargetAtTime(0,t+p0*.5,0.01);
			this.delaylfogaingain.setValueAtTime(.1*(tick&2),t);
			break;
		case "0":
		default:
			this.delaylfogaingain.setValueAtTime(0,t);
			this.outdelay.setValueAtTime(0,t);
			this.gaingain.setValueAtTime(this._v,t);
		}
	}
}
function Speech(){
	this.utter=new SpeechSynthesisUtterance();
	this.loop=16;
	this.lang="en";
	this.pitch="1";
	this.rate="1";
	this.vol="1";
	this.text=[];
	this.textidx=0;
	this.voices=speechSynthesis.getVoices();
	this.SetText=function(s){
		this.text=s.split(",");
	};
	this.SetRate=function(s){
		this.rate=s;
	};
	this.SetPitch=function(s){
		this.pitch=s;
	};
	this.SetLang=function(s){
		this.lang=s;
	}
	this.SetLoop=function(s){
		var i=parseFloat(s);
		if(i>=16)
			this.loop=i;
	};
	this.SetVol=function(s){
		this.vol=s;
	};
	this.SetVoice=function(s){
		this.voice=s;
	};
	this.next=function(t){
		if((tick%this.loop)==0){
			if(this.text.length>0){
        var t=this.text[this.textidx%this.text.length];
        if(t.length>0){
//          console.log("speech:"+t);
  				this.utter.text=t;
  				this.utter.pitch=numeval(this.pitch);
  				this.utter.rate=numeval(this.rate);
  				this.utter.volume=numeval(this.vol);
  				this.utter.voice=this.voices[numeval(this.voice)];
  				this.utter.lang=this.lang;
  				speechSynthesis.speak(this.utter);
        }
				if(++this.textidx>=this.text.length)
					this.textidx=0;
			}
		}
	};
}
function Delay() {
	this.Dly=audioctx.createDelay();
	this.Dly.delayTime.value=60/master._tempo;
	this.Fb=audioctx.createGain();
	this.Fb.gain.value=.5;
	this.Dly.connect(this.Fb);
	this.Dly.connect(out);
	this.Fb.connect(this.Dly)
	this.t=8;
	this.fb=.5;
	this.next=function() {
		var n=4/numeval(this.t);
		this.Fb.gain.value=numeval(this.fb);
		this.Dly.delayTime.value=60*n/master._tempo+0.02;
	};
}
function MidiIn(e){
	for(var i=midicb.length-1;i>=0;--i)
		midicb[i].func.bind(midicb[i].plug)(e);
	if((e.data[0]&0xf0)==0xb0){
		var ccnum=e.data[1]&0x7f;
		cc[ccnum]=e.data[2]/127;
	}
}
function Midi() {
	console.log("---MIDI---");
	this.port=0;
	dmxout=null;
	this.onMIDIFailure=function(msg) {console.log(msg);};
	this.onMIDISuccess=function(ac) {
		console.log("requestMIDIAccess:success");
		var i=ac.outputs.values();
		midioutputs=[];
		for (var o=i.next(); !o.done; o=i.next()) {
			midioutputs.push(o.value);
			console.log(o.value);
			if(o.value.name=="MocoLUFA"){
				dmxout=o.value;
			}
		}
		console.log("number of midiout ports:"+midioutputs.length);
		i=ac.inputs.values();
		midiinputs=[];
		for(o=i.next();!o.done;o=i.next()){
			midiinputs.push(o.value);
			o.value.onmidimessage=MidiIn;
		}
	};
	if(navigator.requestMIDIAccess) {
		navigator.requestMIDIAccess().then(this.onMIDISuccess,this.onMIDIFailure);
		this.setup=function(midiout) {
			if(midiout) {
				midiout.send([0xb0,70,125]);	//detune
				midiout.send([0xb0,76,55]);	//lfo rate
			}
		}
	}
}
function Cmds() {
	this.cursor=0;
	this.log=[];
	this.log.push("> ");
	this.hist=[];
	this.histcur=0;
	this.rows=25;
	this.dirty=1;
	this.message=function(mess) {
		this.log.splice(1,0,mess);
		if(this.log.length>this.rows)
			this.log.length=this.rows;
		this.dirty=1;
	}
	this.input=function(s){
		s=Enter(s);
		this.cursor=0;
		if(s!=undefined) {
			var ss=s.split("\n");
			for(ii=0;ii<ss.length-1;++ii) {
				this.log.unshift(ss[ii]);
				this.log.length=this.rows;
			}
		}
		this.log.unshift("> ");
		this.dirty=1;
	}
	this.key=function(k) {
		if(k[0]=="f") {
			this.log[0]="> "+fn[k[1]-1];
			this.cursor=this.log[0].length;
			this.dirty=1;
			return;
		}
		switch(k) {
    case 9:
      var i;
      if(this.hist.length>0){
        for(i=0;i<this.hist.length;++i){
          if(this.hist[i].indexOf(this.log[0])==0){
            this.log[0]=this.hist[i];
            this.cursor=this.log[0].length;
    				this.dirty=1;
            break;
          }
        }
      }
      return;
		case "l":
			return;
		case "u":
			if(this.histcur<this.hist.length-1) {
				++this.histcur;
				this.log[0]=this.hist[this.histcur];
				this.cursor=this.log[0].length;
				this.dirty=1;
			}
			return;
		case "r":
			return;
		case "d":
			if(this.histcur>=0) {
				--this.histcur;
				if(this.histcur==-1) {
					this.log[0]="> ";
					this.cursor=2;
				}
				else {
					this.log[0]=this.hist[this.histcur];
					this.cursor=this.log[0].length;
				}
				this.dirty=1;
			}
			return;
		case 8:
			if(this.cursor>2) {
				this.log[0]=this.log[0].slice(0,-1);
				--this.cursor;
				this.dirty=1;
			}
			return;
		case 13:
			this.histcur=-1;
			this.hist.unshift(this.log[0]);
			if(this.hist.length>10)
				this.hist.length=10;
			this.input(this.log[0].substr(2));
			return;
		}
		var s=String.fromCharCode(k);
		this.log[0]+=s;
		this.cursor=this.log[0].length;
		this.histcur=-1;
		this.dirty=1;
	}
}
function Video() {
	this.video=document.getElementById("video");
	this.play=0;
	function err(err) {
		console.log(err);
		cmds.message("video is not available.");
	}
	function success(stream) {
		console.log("stream:"+stream);
		this.video.srcObject = stream;
		this.video.width=320;
		this.video.height=240;
		this.stream=stream;
		this.video.play();
	}
	this.cam=[];
	if(nocam!=1){
		navigator.mediaDevices.enumerateDevices({video:true}).then(
			function(devices){
				for(var i=0,j=0,len=devices.length;i<len;++i){
					var device=devices[i];
					if(device.kind=="videoinput"){
						cmds.message("video "+j+":"+device.deviceId);
						this.cam.push(device.deviceId);
						++j;
					}
				}
				this.Switch(0);
			}.bind(this)
		);
	}
	this.Switch=function(n){
		if(n<0||n>=this.cam.length)
			return;
		console.log("video switch:"+this.cam[n]);
		
		if(this.video.srcObject){
			const trk=this.video.srcObject.getTracks();
			trk.forEach(function(track){track.stop();});
		}
		navigator.mediaDevices.getUserMedia({video:{deviceId:this.cam[n]},audio:false}).then(success.bind(this),err);
	};
}
function Start(){
	audioctx.resume();
	const s=document.getElementById("splash");
	s.style.display="none";
	video.video.play();
}
</script>
<div id="base" style="position:absolute;left:0px;top:0px;background:#000;overflow:hidden">
</div>
<div id="topmost" style="position:absolute;left:0px;top:0px;overflow:hidden">
</div>
<div id="splash">
<button style="display:block;position:absolute;left:25%;top:40%;width:50%;height:20%" onclick="Start()">Start</button>	
</div>
<input id="cmdline" onchange="CmdlineInput()" style="display:none;width:100%;position:absolute;left:0;bottom:0;border:none"/>
<div id="timecode" style="position:absolute;border:none;margin:0px;padding:0px;right:2px;bottom:5px;width:120px;height:20px;color:#aaa;font-size:20px;font-family:courier"></div>
<div id="urlpane">
	<div style="width:90%;margin:auto">
		<textarea id="url">
		</textarea><br/>
		<input type="checkbox"/>Use WebCam<br/>
		<button onclick="document.getElementById('urlpane').style.display='none';">Close</button>
	</div>
</div>
<div style="display:none">
	<video id="video" width="1" height="1"></video>
<!--	<canvas id="cvcamwork" width="256" height="256"></canvas>-->
</div>
</body>
</html>
